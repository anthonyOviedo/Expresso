name: test-cli-artifacts

on:
  workflow_call:
    inputs:
      app_name:
        description: Application name
        required: true
        type: string
      main_class:
        description: CLI main class
        required: true
        type: string
      version:
        description: Application version
        required: true
        type: string

permissions:
  contents: read

jobs:
  test-rest-jar:
    runs-on: ubuntu-latest
    env:
      APP_NAME: ${{ inputs.app_name }}
      MAIN_CLASS: ${{ inputs.main_class }}
      VERSION: ${{ inputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Temurin JDK 24
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '24'

      - name: Download REST JAR
        uses: actions/download-artifact@v4
        with:
          name: "${{ env.APP_NAME }}-${{ env.VERSION }}-rest.jar"
          path: target

      - name: Validate REST health endpoint
        run: |
          set -euo pipefail
          REST_JAR=$(find target -maxdepth 1 -name '*.jar' -print -quit)
          echo "Launching $REST_JAR"
          export SERVER_PORT=8081
          java -jar "$REST_JAR" >/tmp/rest.log 2>&1 &
          cleanup() {
            kill %1 >/dev/null 2>&1 || true
            wait %1 >/dev/null 2>&1 || true
            cat /tmp/rest.log || true
          }
          trap cleanup INT TERM EXIT
          for _ in $(seq 1 30); do
            if curl -sSf http://127.0.0.1:8081/api/v1/health | grep -q 'ok'; then
              echo "REST healthcheck passed"
              exit 0
            fi
            sleep 2
          done
          echo "REST healthcheck failed" >&2
          exit 1

  test-cli-jar:
    runs-on: ubuntu-latest
    env:
      APP_NAME: ${{ inputs.app_name }}
      MAIN_CLASS: ${{ inputs.main_class }}
      VERSION: ${{ inputs.version }}
    steps:
      - name: Set up Temurin JDK 24
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '24'

      - uses: actions/checkout@v4

      - name: Download CLI JAR
        uses: actions/download-artifact@v4
        with:
          name: "${{ env.APP_NAME }}-${{ env.VERSION }}.jar"
          path: target

      - name: Smoke test CLI JAR
        run: |
          set -euo pipefail
          CLI_JAR=$(find target -maxdepth 1 -name '*.jar' -print -quit)
          echo "Testing $CLI_JAR"
          java -jar "$CLI_JAR" --help
          mkdir -p output
          java -jar "$CLI_JAR" transpile examples/HelloWorld0.expresso --out output --verbose
          java -jar "$CLI_JAR" build examples/HelloWorld0.expresso --out output --verbose
          java -jar "$CLI_JAR" run examples/HelloWorld0.expresso --out output --verbose
