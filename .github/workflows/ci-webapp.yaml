name: build-and-test-webapp

on:
  workflow_call:
    inputs:
      app_name:
        description: Application name
        required: true
        type: string
      version:
        description: Application version
        required: true
        type: string

permissions:
  contents: read

jobs:
  docker:
    runs-on: ubuntu-latest
    env:
      APP_NAME: ${{ inputs.app_name }}
      VERSION: ${{ inputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Download REST JAR
        uses: actions/download-artifact@v4
        with:
          name: "${{ env.APP_NAME }}-${{ env.VERSION }}-rest.jar"
          path: artifacts

      - name: Build Docker image
        run: |
          set -euo pipefail
          REST_JAR=$(find artifacts -maxdepth 1 -name '*.jar' -print -quit)
          if [ -z "$REST_JAR" ]; then
            echo "Rest jar not found" >&2
            exit 1
          fi
          mkdir -p expresso-rest/target
          cp "$REST_JAR" expresso-rest/target/
          docker build -f dockerfile -t ${{ env.APP_NAME }}-rest:${{ env.VERSION }} .

      - name: Smoke test Docker image
        run: |
          set -euo pipefail
          IMAGE="${APP_NAME}-rest:${VERSION}"
          CONTAINER="rest-smoke-${GITHUB_RUN_NUMBER}"
          docker run --rm -d --name "$CONTAINER" -e SERVER_PORT=8082 -p 8082:8082 "$IMAGE"
          cleanup() {
            docker logs "$CONTAINER" || true
            docker stop "$CONTAINER" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT
          for _ in $(seq 1 30); do
            if curl -sSf http://127.0.0.1:8082/api/v1/health | grep -q 'ok'; then
              echo "Dockerized REST healthcheck passed"
              exit 0
            fi
            sleep 2
          done
          echo "Dockerized REST API failed healthcheck" >&2
          exit 1
