name: CI Pipeline

on:
  push:
    branches: [dev, main]

permissions:
  contents: write
  packages: write
  actions: write

env:
  APP_NAME: expressor
  MAIN_CLI_CLASS: com.diezam04.expresso.adapters.cli.Cli
  MAIN_REST_CLASS: com.diezam04.expresso.adapters.rest.RestApi
  VERSION: 3.2
  DOCKERHUB_USERNAME: antonyoviedo

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Temurin JDK 24
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '24'
          cache: maven

      - name: Build with Maven
        run: mvn -B -DskipTests package

      - name: Check Docker Hub credentials
        id: check_docker
        run: |
          if [ -n "${DOCKERHUB_USERNAME:-}" ] && [ -n "${DOCKERHUB_TOKEN:-}" ]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Prepare release JARs
        id: prepare
        env:
          APP_NAME: ${{ env.APP_NAME }}
          VERSION: ${{ env.VERSION }}
        run: |
          set -euo pipefail
          CLI_JAR=$(find expresso-cli/target -maxdepth 1 -type f -name '*-shaded.jar' | sort | head -n1)
          [ -z "$CLI_JAR" ] && CLI_JAR=$(find expresso-cli/target -maxdepth 1 -type f -name '*.jar' | sort | head -n1)
          [ -z "$CLI_JAR" ] && { echo "No CLI jar found under expresso-cli/target" >&2; exit 1; }

          REST_JAR=$(find expresso-rest/target -maxdepth 1 -type f -name '*-shaded.jar' | sort | head -n1)
          [ -z "$REST_JAR" ] && REST_JAR=$(find expresso-rest/target -maxdepth 1 -type f -name '*.jar' | sort | head -n1)
          [ -z "$REST_JAR" ] && { echo "No REST jar found under expresso-rest/target" >&2; exit 1; }

          RELEASE_CLI="${APP_NAME}-${VERSION}-cli.jar"
          RELEASE_REST="${APP_NAME}-${VERSION}-rest.jar"
          cp "$CLI_JAR" "expresso-cli/target/${RELEASE_CLI}"
          cp "$REST_JAR" "expresso-rest/target/${RELEASE_REST}"

          echo "cli_path=expresso-cli/target/${RELEASE_CLI}" >> "$GITHUB_OUTPUT"
          echo "rest_path=expresso-rest/target/${RELEASE_REST}" >> "$GITHUB_OUTPUT"

      - name: Validate REST health endpoint
        run: |
          set -euo pipefail
          REST_JAR="${{ steps.prepare.outputs.rest_path }}"
          echo "Launching $REST_JAR"
          export SERVER_PORT=8081
          java -jar "$REST_JAR" >/tmp/rest.log 2>&1 &
          cleanup() {
            kill %1 >/dev/null 2>&1 || true
            wait %1 >/dev/null 2>&1 || true
            cat /tmp/rest.log || true
          }
          trap cleanup INT TERM EXIT
          for _ in $(seq 1 30); do
            if curl -sSf http://127.0.0.1:8081/api/v1/health | grep -q 'ok'; then
              echo "REST healthcheck passed"
              exit 0
            fi
            sleep 2
          done
          echo "REST healthcheck failed" >&2
          exit 1

      - name: Smoke test CLI jar
        run: |
          set -euo pipefail
          CLI_JAR="${{ steps.prepare.outputs.cli_path }}"
          echo "Testing $CLI_JAR"
          java -jar "$CLI_JAR" --help
          mkdir -p output
          java -jar "$CLI_JAR" transpile examples/HelloWorld0.expresso --out output --verbose
          java -jar "$CLI_JAR" build     examples/HelloWorld0.expresso --out output --verbose
          java -jar "$CLI_JAR" run       examples/HelloWorld0.expresso --out output --verbose

      - name: Upload CLI jar
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.APP_NAME }}-${{ env.VERSION }}-cli.jar"
          path: "${{ steps.prepare.outputs.cli_path }}"
          if-no-files-found: error

      - name: Upload REST jar
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.APP_NAME }}-${{ env.VERSION }}-rest.jar"
          path: "${{ steps.prepare.outputs.rest_path }}"
          if-no-files-found: error

  package-msi:
    needs: build-and-test
    runs-on: windows-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up Temurin JDK 24
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '24'

      - name: Download JARs
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ env.VERSION }}-cli.jar
          path: target

      - name: jpackage -> MSI (CLI-only)
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path out | Out-Null
          jpackage `
            --type msi `
            --name "$env:APP_NAME" `
            --input target `
            --main-jar "${{ env.APP_NAME }}-${{ env.VERSION }}-cli.jar" `
            --main-class "$env:MAIN_CLASS" `
            --win-add-to-path
          $msi = Get-ChildItem -Path . -Filter *.msi | Select-Object -First 1
          if (-not $msi) { throw "MSI not produced" }
          Move-Item -Force $msi.FullName (Join-Path "dist" $msi.Name)
      
      - name: Upload .msi
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ env.VERSION }}.msi
          path: dist/*.msi
          if-no-files-found: error
