name: CI (one job, fast)

on:
  push:
    branches: [dev, main]

permissions:
  contents: write
  packages: write
  actions: write

env:
  APP_NAME: expressor
  MAIN_CLI_CLASS: com.diezam04.expresso.adapters.cli.Cli
  MAIN_REST_CLASS: com.diezam04.expresso.adapters.rest.RestApi
  VERSION: 3.2
  DOCKERHUB_USERNAME: antonyoviedo

jobs:
  build-package-release:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Temurin JDK 24
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '24'
          cache: maven

      - name: Build with Maven (all modules)
        run: mvn -B -DskipTests package

      - name: Find built jars
        id: jars
        shell: bash
        run: |
          set -e
          CLI_JAR=$(ls -1 expresso-cli/target/*.jar | head -n1)
          REST_JAR=$(ls -1 expresso-rest/target/*.jar | head -n1)
          echo "cli=$CLI_JAR"   >> "$GITHUB_OUTPUT"
          echo "rest=$REST_JAR" >> "$GITHUB_OUTPUT"

      # ---------- Linux path: test + .deb + docker + release assets ----------
      - name: REST health (Linux)
        if: runner.os == 'Linux'
        run: |
          set -e
          export SERVER_PORT=8081
          java -jar "${{ steps.jars.outputs.rest }}" >/tmp/rest.log 2>&1 &
          PID=$!
          for _ in $(seq 1 30); do
            curl -fsS http://127.0.0.1:8081/api/v1/health | grep -q ok && break || sleep 2
          done
          kill $PID || true

      - name: Smoke CLI (Linux)
        if: runner.os == 'Linux'
        run: |
          set -e
          java -jar "${{ steps.jars.outputs.cli }}" --help
          mkdir -p output
          java -jar "${{ steps.jars.outputs.cli }}" transpile examples/HelloWorld0.expresso --out output --verbose
          java -jar "${{ steps.jars.outputs.cli }}" build     examples/HelloWorld0.expresso --out output --verbose
          java -jar "${{ steps.jars.outputs.cli }}" run       examples/HelloWorld0.expresso --out output --verbose

      - name: Write Debian maintainer scripts (PATH symlink)
        if: runner.os == 'Linux'
        run: |
          mkdir -p packaging
          cat > packaging/postinst <<EOF
          #!/bin/sh
          set -e
          ln -sf /opt/${APP_NAME}/bin/${APP_NAME} /usr/local/bin/${APP_NAME}
          exit 0
          EOF
          cat > packaging/postrm <<EOF
          #!/bin/sh
          set -e
          rm -f /usr/local/bin/${APP_NAME}
          exit 0
          EOF
          chmod 755 packaging/postinst packaging/postrm

      - name: jpackage -> .deb (Linux)
        if: runner.os == 'Linux'
        run: |
          set -e
          mkdir -p dist
          jpackage \
            --type deb \
            --name "${APP_NAME}" \
            --linux-package-name "${APP_NAME}" \
            --input "$(dirname '${{ steps.jars.outputs.cli }}')" \
            --main-jar "$(basename '${{ steps.jars.outputs.cli }}')" \
            --main-class "${MAIN_CLI_CLASS}" \
            --app-version "${VERSION}" \
            --linux-deb-maintainer "Expresso Team <antony-08@hotmail.com>" \
            --resource-dir packaging \
            --dest dist
          mv dist/*.deb "dist/${APP_NAME}-${VERSION}.deb"

      - name: Docker login (Linux, if secrets present)
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push Docker image (Linux)
        run: |
          set -e
          docker build -t ${{ env.DOCKERHUB_USERNAME }}/expresso:latest .
          docker push ${{ env.DOCKERHUB_USERNAME }}/expresso:latest

      # ---------- Windows path: MSI ----------
      - name: Install WiX (optional, harmless)
        if: runner.os == 'Windows'
        shell: powershell
        run: choco install wixtoolset -y

      - name: jpackage -> .msi (+PATH)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $cliJar   = "${{ steps.jars.outputs.cli }}"
          $inputDir = Split-Path -Parent $cliJar
          $mainJar  = Split-Path -Leaf   $cliJar
          jpackage `
            --type msi `
            --name "$env:APP_NAME" `
            --input "$inputDir" `
            --main-jar "$mainJar" `
            --main-class "$env:MAIN_CLI_CLASS" `
            --app-version "$env:VERSION" `
            --dest dist `
            --win-add-to-path `
            --vendor "$env:APP_NAME"

      # ---------- Release (each leg uploads its own assets to same tag) ----------
      - name: Create/Update GitHub Release + upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}"
          target_commitish: ${{ github.sha }}
          name: "${{ env.APP_NAME }} v${{ env.VERSION }}"
          generate_release_notes: true
          files: |
            ${{ steps.jars.outputs.cli }}
            ${{ steps.jars.outputs.rest }}
            dist/*.deb
            dist/*.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------- Discord notify once (Linux only) ----------
      - name: Discord notify (success)
        if: runner.os == 'Linux' && success()
        uses: Ilshidur/action-discord@0.3.2
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            ✅ **Release created**
            • App: **${{ env.APP_NAME }}** v${{ env.VERSION }}
            • Tag: `${{ github.ref_name }}`
            • Author: ${{ github.actor }}
            • Commit: `${{ github.sha }}`
            • Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Discord notify (failure)
        if: runner.os == 'Linux' && failure()
        uses: Ilshidur/action-discord@0.3.2
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            ❌ **Release failed**
            • App: **${{ env.APP_NAME }}** v${{ env.VERSION }}
            • Ref: `${{ github.ref_name }}`
            • Author: ${{ github.actor }}
            • Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
