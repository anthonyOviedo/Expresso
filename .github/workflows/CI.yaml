name: CI Pipeline

on:
  push:
    branches:
      - dev
      - main

permissions:
  contents: write
  packages: write

env:
  APP_NAME: expressor
  MAIN_CLI_CLASS: com.diezam04.expresso.adapters.cli.Cli
  MAIN_REST_CLASS: com.diezam04.expresso.adapters.rest.RestApi

jobs:
  build-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    outputs:
      version: ${{ steps.stage.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Temurin JDK 24
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '24'
          cache: maven

      - name: Build project
        run: mvn -B clean package

      - name: Stage artifacts
        id: stage
        run: |
          set -euo pipefail
          VERSION=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          DIST=dist
          mkdir -p "$DIST"

          CLI_JAR=$(find expresso-cli/target -maxdepth 1 -type f -name "expresso-cli-*.jar" ! -name "original-*.jar" -print -quit)
          REST_JAR=$(find expresso-rest/target -maxdepth 1 -type f -name "expresso-rest-*.jar" ! -name "*.original" -print -quit)

          if [ -z "$CLI_JAR" ]; then
            echo "Unable to locate CLI jar" >&2
            exit 1
          fi
          if [ -z "$REST_JAR" ]; then
            echo "Unable to locate REST jar" >&2
            exit 1
          fi

          CLI_DEST="${APP_NAME}-${VERSION}-cli.jar"
          REST_DEST="${APP_NAME}-${VERSION}-rest.jar"

          cp "$CLI_JAR" "$DIST/$CLI_DEST"
          cp "$REST_JAR" "$DIST/$REST_DEST"

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "cli=$DIST/$CLI_DEST" >> "$GITHUB_OUTPUT"
          echo "rest=$DIST/$REST_DEST" >> "$GITHUB_OUTPUT"

      - name: Smoke test CLI
        run: |
          set -euo pipefail
          CLI_JAR='${{ steps.stage.outputs.cli }}'
          java -jar "$CLI_JAR" --help
          mkdir -p tmp-output
          java -jar "$CLI_JAR" transpile examples/HelloWorld0.expresso --out tmp-output --verbose
          java -jar "$CLI_JAR" build examples/HelloWorld0.expresso --out tmp-output --verbose
          java -jar "$CLI_JAR" run examples/HelloWorld0.expresso --out tmp-output --verbose
          java -jar "$CLI_JAR" -V

      - name: Smoke test REST API
        run: |
          set -euo pipefail
          REST_JAR='${{ steps.stage.outputs.rest }}'
          export SERVER_PORT=8081
          java -jar "$REST_JAR" >/tmp/rest.log 2>&1 &
          PID=$!
          cleanup() {
            kill "$PID" >/dev/null 2>&1 || true
            wait "$PID" >/dev/null 2>&1 || true
            tail -n 100 /tmp/rest.log || true
          }
          trap cleanup EXIT
          for _ in $(seq 1 30); do
            if curl -sSf "http://127.0.0.1:${SERVER_PORT}/api/v1/health" | grep -q 'ok'; then
              exit 0
            fi
            sleep 2
          done
          echo "REST API failed healthcheck" >&2
          exit 1

      - name: Build Debian package (jpackage)
        run: |
          set -euo pipefail
          VERSION='${{ steps.stage.outputs.version }}'
          DIST=dist
          CLI_JAR_BASENAME=$(basename '${{ steps.stage.outputs.cli }}')

          mkdir -p packaging/debian
          cat <<'EOF' | sed 's/^ *//' > packaging/debian/postinst
            #!/bin/sh
            set -e
            ln -sf /opt/${APP_NAME}/bin/${APP_NAME} /usr/local/bin/${APP_NAME}
            exit 0
          EOF
          cat <<'EOF' | sed 's/^ *//' > packaging/debian/postrm
            #!/bin/sh
            set -e
            rm -f /usr/local/bin/${APP_NAME}
            exit 0
          EOF
          chmod 755 packaging/debian/postinst packaging/debian/postrm

          jpackage \
            --type deb \
            --name "${APP_NAME}" \
            --linux-package-name "${APP_NAME}" \
            --input "$DIST" \
            --main-jar "$CLI_JAR_BASENAME" \
            --main-class "${MAIN_CLI_CLASS}" \
            --app-version "$VERSION" \
            --linux-deb-maintainer "Expresso Team <support@expresso.dev>" \
            --resource-dir packaging/debian \
            --dest "$DIST" \
            --verbose

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: expressor-${{ steps.stage.outputs.version }}-linux
          path: dist/

  package-windows:
    runs-on: windows-latest
    timeout-minutes: 30
    needs: build-linux
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Temurin JDK 24
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '24'

      - name: Download staged artifacts
        uses: actions/download-artifact@v4
        with:
          name: expressor-${{ needs.build-linux.outputs.version }}-linux
          path: dist

      - name: Build Windows executable (jpackage)
        shell: pwsh
        run: |
          $version = '${{ needs.build-linux.outputs.version }}'
          $dist = "dist"
          $cliJar = Join-Path $dist "${env:APP_NAME}-$version-cli.jar"
          if (-not (Test-Path $cliJar)) {
            throw "CLI jar not found at $cliJar"
          }

          $outputDir = Join-Path $dist "windows"
          New-Item -ItemType Directory -Force -Path $outputDir | Out-Null

          jpackage `
            --type exe `
            --name "$env:APP_NAME" `
            --app-version "$version" `
            --input $dist `
            --main-jar (Split-Path -Leaf $cliJar) `
            --main-class "$env:MAIN_CLI_CLASS" `
            --win-console `
            --dest $outputDir `
            --verbose

          $exe = Get-ChildItem -Path $outputDir -Filter "*.exe" | Select-Object -First 1
          if (-not $exe) {
            throw "jpackage did not produce an executable"
          }
          Write-Host "Generated executable: $($exe.FullName)"

      - name: Upload Windows executable
        uses: actions/upload-artifact@v4
        with:
          name: expressor-${{ needs.build-linux.outputs.version }}-windows
          path: dist/windows/*.exe
