name: release-cli-artifacts

on:
  workflow_call:
    inputs:
      dockerhub_available:
        description: Whether Docker Hub credentials are configured
        required: true
        type: string
    outputs:
      release_url:
        description: URL of the GitHub release (may be empty on failure)
        value: ${{ jobs.release.outputs.release_url }}

env:
  APP_NAME: expresso
  MAIN_CLASS: com.diezam04.expresso.adapters.cli.Cli
  VERSION: 3.2

permissions:
  contents: write
  actions: write

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      release_url: ${{ steps.gh_release.outputs.html_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Download built JAR
        uses: actions/download-artifact@v4
        with:
          name: "${{ env.APP_NAME }}-${{ env.VERSION }}.jar"
          path: artifacts/cli

      - name: Download REST JAR
        uses: actions/download-artifact@v4
        with:
          name: "${{ env.APP_NAME }}-${{ env.VERSION }}-rest.jar"
          path: artifacts/rest

      - name: Download .deb
        uses: actions/download-artifact@v4
        with:
          name: "expressor-cli-${{ env.VERSION }}.deb"
          path: artifacts/deb

      - name: Download .msi
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ env.VERSION }}.msi
          path: artifacts/msi

      - name: Download .exe
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ env.VERSION }}.exe
          path: artifacts/exe

      - name: Stage REST JAR for release image
        shell: bash
        run: |
          set -euo pipefail
          REST_JAR=$(find artifacts/rest -maxdepth 1 -name '*.jar' -print -quit)
          if [ -z "$REST_JAR" ]; then
            echo "REST jar not found" >&2
            exit 1
          fi
          mkdir -p expresso-rest/target
          cp "$REST_JAR" expresso-rest/target/

      - name: Build REST Docker image (release copy)
        run: docker build -f dockerfile -t ${{ env.APP_NAME }}-rest:${{ env.VERSION }} .

      - name: Docker Hub login
        if: inputs.dockerhub_available == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push REST image to Docker Hub
        if: inputs.dockerhub_available == 'true'
        shell: bash
        run: |
          set -euo pipefail
          LOCAL="${APP_NAME}-rest:${VERSION}"
          REPO="${{ secrets.DOCKERHUB_USERNAME }}/${APP_NAME}-rest"
          SHORT_SHA="${GITHUB_SHA::7}"
          docker tag "$LOCAL" "$REPO:${VERSION}"
          docker tag "$LOCAL" "$REPO:latest"
          docker tag "$LOCAL" "$REPO:${SHORT_SHA}"
          docker push "$REPO:${VERSION}"
          docker push "$REPO:latest"
          docker push "$REPO:${SHORT_SHA}"

      - name: Create GitHub Release + upload assets
        id: gh_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}"
          target_commitish: ${{ github.sha }}
          name: "${{ env.APP_NAME }} v${{ env.VERSION }}"
          generate_release_notes: true
          files: |
            artifacts/cli/*.jar
            artifacts/rest/*.jar
            artifacts/deb/*.deb
            artifacts/msi/*.msi
            artifacts/exe/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Delete uploaded artifacts
        if: ${{ success() }}
        uses: geekyeggo/delete-artifact@v4
        with:
          name: |
            ${{ env.APP_NAME }}-${{ env.VERSION }}.jar
            ${{ env.APP_NAME }}-${{ env.VERSION }}-rest.jar
            expressor-cli-${{ env.VERSION }}.deb
            ${{ env.APP_NAME }}-${{ env.VERSION }}.msi
            ${{ env.APP_NAME }}-${{ env.VERSION }}.exe
